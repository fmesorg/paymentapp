<html>
<head>
    <script type="text/javascript" src="moment.js"></script>
    <script type="text/javascript" src="lodash-min.js"></script>
    <script type="text/javascript" src="registrationDetails.js"></script>
    <script type="text/javascript" src="countries.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
    <script>
        var baseServerURL = 'http://ijme.in/paymentapp/';
        var registrationDetails = registrationDetails();
        var earlyBirdDate = '2018-09-16';
        var countryList = countries();

        var setElementValue = function (id, value) {
            document.getElementById(id).value = value;
        };

        var setElementValueWithURL = function (id, value) {
            setElementValue(id, baseServerURL + value);
        };

        var addOption = function (text, selectElement) {
            var option = document.createElement("option");
            option.text = text;
            selectElement.add(option);
        };

        var clearAllOptions = function (selectElement) {
            for (var i = selectElement.length - 1; i >= 0; i--) {
                selectElement.remove(i);
            }
        };

        var pastEarlyBirdTheDate = function () {
            return moment().isAfter(new Date(earlyBirdDate));
        };

        var isApplicable = function (item) {
            return (_.isEmpty(item["Uptil"]) && !pastEarlyBirdTheDate()) || (!_.isEmpty(item["Uptil"]) && pastEarlyBirdTheDate());
        };

        var displayDependentOptions = function (dependeeElementName, dependentElementName, dependeePropertyName, dependentPropertyName) {
            var dependeeElement = document.getElementById(dependeeElementName);
            var dependentElement = document.getElementById(dependentElementName);
            clearAllOptions(dependentElement);
            addOption('Select', dependentElement);
            _.uniqBy(_.filter(registrationDetails, function (item) {
                return (item[dependeePropertyName] === dependeeElement.options[dependeeElement.selectedIndex].text) && isApplicable(item);
            }), function (item) {
                return item[dependentPropertyName];
            }).forEach(function (item) {
                addOption(item[dependentPropertyName], dependentElement);
            });
        };

        var displayFixedOptions = function (elementId, propertyName) {
            var selectElement = document.getElementById(elementId);
            addOption('Select', selectElement);
            _.uniqBy(registrationDetails, function (item) {
                return item[propertyName];
            }).forEach(function (item) {
                addOption(item[propertyName], selectElement);
            });
        };

        var displayCountries = function () {
            var selectElement = document.getElementById("country");
            addOption('Select', selectElement);
            var allCountries = _.sortBy(countryList["low"].concat(countryList["low-middle"], countryList["upper-middle"], countryList["high"]));
            allCountries.forEach(function (country) {
                addOption(country, selectElement)
            });
        };

        var isValueSelected = function (elementId) {
            return document.getElementById(elementId).selectedIndex !== 0;
        };

        var hasValue = function (elementId) {
            return getSelectedValue(elementId) !== '';
        };

        var getSelectedValue = function (elementId) {
            var element = document.getElementById(elementId);
            return element.value;
        };

        var congressSelected = function () {
            displayDependentOptions("congress", "registrationType", "Congress", "Registration type");
        };

        var findCountry = function (array, country) {
            return array.find(function (item) {
                return item === country;
            });
        };

        var getLocationType = function (country) {
            return (findCountry(countryList["low"], country) || findCountry(countryList["low-middle"], country)) ? "India or low/middle income country" : "Upper middle and high income country";
        };

        var arePaymentFieldsSelected = function() {
            return isValueSelected("congress") && isValueSelected("registrationType") && isValueSelected("participantType") && isValueSelected("country") && isValueSelected("currency");
        };

        var areNonPaymentFieldsSelected = function () {
            return hasValue("billing_name") && hasValue("billing_address") && hasValue("billing_city") && hasValue("billing_state") && hasValue("billing_zip") && hasValue("phone_number");
        };

        var setAmountIfAllRegistrationInputSelected = function () {
            if (arePaymentFieldsSelected()) {
                var congress = getSelectedValue("congress");
                var registrationType = getSelectedValue("registrationType");
                var participantType = getSelectedValue("participantType");
                var country = getSelectedValue("country");
                var locationType = getLocationType(country);
                var registrationDetail = _.find(registrationDetails, function (item) {
                    return item["Congress"] === congress && item["Registration type"] === registrationType && item["Participant"] === participantType && item["Location"] === locationType && isApplicable(item);
                });

                var currency = getSelectedValue("currency");
                // ExpectedAmount = TotalAmount - 0.02 * TotalAmount - 0.02 * 0.18 * TotalAmount
                // ExpectedAmount = TotalAmount * (1 - 0.02 - 0.0036)
                // TotalAmount = ExpectedAmount / (1 - 0.02 - 0.0036)
                // Fees = ExpectedAmount * (0.02) / (1 - 0.02 - 0.0036)
                // GST = ExpectedAmount * (0.02 * 0.18) / (1 - 0.02 - 0.0036)
                var txFeePercentage = currency === 'INR' ? 0.02 : 0.0499;
                var expectedAmount = currency === 'INR' ? registrationDetail["Fees-Rs"] : Number(registrationDetail["Fees-USD"]);

                var total = calculateTotal(expectedAmount, txFeePercentage);
                var transactionFees = calculateTxFee(expectedAmount, txFeePercentage);
                var gst = transactionFees * 0.18;
                document.getElementById("registrationAmount").value = expectedAmount.toFixed(2);
                document.getElementById("feesAndTax").value = (transactionFees + gst).toFixed(2);
                document.getElementById("amount").value = total.toFixed(2);
                setSubmitButtonState(areNonPaymentFieldsSelected());
            } else {
                document.getElementById("amount").value = '';
                setSubmitButtonState(false);
            }
        };

        var calculateTotal = function(expectedAmount, txFeePercentage) {
            var number = expectedAmount / (1 - txFeePercentage - (txFeePercentage * 0.18));
            return Number(number);
        };

        var calculateTxFee = function (expectedAmount, txFeePercent) {
            var number = (expectedAmount * txFeePercent) / (1 - txFeePercent - (txFeePercent * 0.18));
            return Number(number);
        };

        var registrationTypeSelected = function () {
            setAmountIfAllRegistrationInputSelected();
        };

        var participantTypeSelected = function () {
            setAmountIfAllRegistrationInputSelected();
        };

        var countrySelected = function () {
            setAmountIfAllRegistrationInputSelected();
        };

        var currencySelected = function () {
            setAmountIfAllRegistrationInputSelected();
        };

        var updatePhoneNumber = function () {
            var phoneNumber = document.getElementById("phone_number");
            document.getElementById("billing_tel").value = phoneNumber.value;
            enableSubmitIfAllFilled();
        };

        var enableSubmitIfAllFilled = function() {
            setSubmitButtonState(arePaymentFieldsSelected() && areNonPaymentFieldsSelected());
        };

        var setSubmitButtonState = function(enabled) {
            var submitButton = document.getElementById('submit');
            submitButton.disabled = !enabled;
        };

        window.onload = function () {
            setElementValue('tid', moment().format('YYMMDDhhmmss'));
            setElementValue("order_id", '00000000000000' + moment().format('YYYYMMDDhhmmssss'));
            setElementValueWithURL('redirect_url', 'ccavResponseHandler.php');
            setElementValueWithURL('cancel_url', 'ccavResponseHandler.php');

            displayFixedOptions("congress", "Congress");
            displayFixedOptions("participantType", "Participant");
            var selectElement = document.getElementById("currency");
            addOption('Select', selectElement);
            addOption('INR', selectElement);
            addOption('USD', selectElement);

            displayCountries();
            setSubmitButtonState(false);
        };
    </script>
</head>
<body>
<br/>
<center>
    <div>
        <img alt="world-congress-of-bioethics-logo" src="http://ijme.in/nbc-20140321/custom/img/14-world-congress-of-bioethics-logo.jpg" style="{float: left}">
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <img alt="NBC Logo" src="http://ijme.in/nbc-20140321/custom/img/nbc-logo.jpg">
    </div>
</center>
<br/>
<br/>
<center>
    <h1>Please provide your details below</h1></center>
<form method="post" name="customerData" action="ccavRequestHandler.php" role="form">
    <table width="60%" height="100" align="center" border="1" bgcolor="#D3D3D3">
        <tr>
            <td colspan="2">
                <center><b>Congress details</b></center>
            </td>
        </tr>
        <tr>
            <td>Please choose your congress type</td>
            <td>
                <select id="congress" name="merchant_param1" onchange="congressSelected()"></select>
            </td>
        </tr>
        <tr>
            <td>Please choose your registration type</td>
            <td>
                <select id="registrationType" name="merchant_param2" onchange="registrationTypeSelected()"></select>
            </td>
        </tr>
        <tr>
            <td>Please choose your participation type</td>
            <td>
                <select id="participantType" name="merchant_param3" onchange="participantTypeSelected()"></select>
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <center><b>Billing information (all fields mandatory)</b></center>
            </td>
        </tr>
        <tr>
            <td>Name :</td>
            <td><input type="text" id="billing_name" name="billing_name" value="" size="30" oninput="enableSubmitIfAllFilled()"/></td>
        </tr>
        <tr>
            <td>Address :</td>
            <td><input type="text" id="billing_address" name="billing_address" value="" size="30" oninput="enableSubmitIfAllFilled()"/></td>
        </tr>
        <tr>
            <td>City :</td>
            <td><input type="text" id="billing_city" name="billing_city" value="" size="30" oninput="enableSubmitIfAllFilled()"/></td>
        </tr>
        <tr>
            <td>State :</td>
            <td><input type="text" id="billing_state" name="billing_state" value="" size="30" oninput="enableSubmitIfAllFilled()"/></td>
        </tr>
        <tr>
            <td>Zip/Postal code :</td>
            <td><input type="text" id="billing_zip" name="billing_zip" value="" size="30" oninput="enableSubmitIfAllFilled()"/></td>
        </tr>
        <tr>
            <td>Country :</td>
            <td><select id="country" name="billing_country" onchange="countrySelected()"></select></td>
        </tr>
        <tr>
            <td>Contact number (please include the country code):</td>
            <td>
                <span>+</span>
                <input type="text" name="phone_number" id="phone_number" oninput="updatePhoneNumber()" size="15"/>
                <input type="text" name="billing_tel" id="billing_tel" hidden/>
            </td>
        </tr>
        <tr>
            <td>Email :</td>
            <td><input type="text" id="billing_email" name="billing_email" value="" size="30" oninput="enableSubmitIfAllFilled()"/></td>
        </tr>
        <tr>
            <td>Currency :</td>
            <td>
                <select id="currency" name="currency" onchange="currencySelected()"></select>
            </td>
        </tr>
        <tr>
            <td>Registration amount :</td>
            <td><input type="text" name="registrationAmount" id="registrationAmount" readonly style="background-color: #D3D3D3; border: 0"/></td>
        </tr>
        <tr>
            <td>Transaction fees and GST :</td>
            <td><input type="text" name="feesAndTax" id="feesAndTax" readonly style="background-color: #D3D3D3; border: 0"/></td>
        </tr>
        <tr>
            <td>Total amount :</td>
            <td><input type="text" name="amount" id="amount" style="background-color: #D3D3D3; border: 0"/></td>
        </tr>
    </table>
    <br/>
    <center><INPUT TYPE="submit" id="submit" value="Proceed to payment" class="btn btn-primary btn-lg"></center>
    <input type="text" name="language" value="en" hidden/>
    <input type="text" name="integration_type" value="iframe_normal" hidden/>
    <input type="text" name="redirect_url" id="redirect_url" hidden/>
    <input type="text" name="cancel_url" id="cancel_url" hidden/>
    <input type="text" name="tid" id="tid" hidden/>
    <input type="text" name="merchant_id" value="146983" hidden/>
    <input type="text" name="order_id" id="order_id" hidden/>
</form>
</body>
</html>