<html>
<head>
    <script type="text/javascript" src="moment.js"></script>
    <script type="text/javascript" src="lodash-min.js"></script>
    <script type="text/javascript" src="registrationDetails.js"></script>
    <script>
        var baseServerURL = 'http://ijme.in/paymentapp/';
        var registrationDetails = registrationDetails();

        var setElementValue = function (id, value) {
            document.getElementById(id).value = value;
        };

        var setElementValueWithURL = function (id, value) {
            setElementValue(id, baseServerURL + value);
        };

        var addOption = function (text, selectElement) {
            var option = document.createElement("option");
            option.text = text;
            selectElement.add(option);
        };

        var clearAllOptions = function (selectElement) {
            for (var i = selectElement.length - 1; i >= 0; i--) {
                selectElement.remove(i);
            }
        };

        var pastTheDate = function (dateString) {
            if (_.isEmpty(dateString)) return false;
            return moment().isAfter(new Date(dateString));
        };

        var displayDependentOptions = function (dependeeElementName, dependentElementName, dependeePropertyName, dependentPropertyName) {
            var dependeeElement = document.getElementById(dependeeElementName);
            var dependentElement = document.getElementById(dependentElementName);
            clearAllOptions(dependentElement);
            addOption('Select', dependentElement);
            _.uniqBy(_.filter(registrationDetails, function (item) {
                return item[dependeePropertyName] === dependeeElement.options[dependeeElement.selectedIndex].text && !pastTheDate(item["Uptil"]);
            }), function (item) {
                return item[dependentPropertyName];
            }).forEach(function (item) {
                addOption(item[dependentPropertyName], dependentElement);
            });
        };

        var displayFixedOptions = function (elementId, propertyName) {
            var selectElement = document.getElementById(elementId);
            addOption('Select', selectElement);
            _.uniqBy(registrationDetails, function (item) {
                return item[propertyName];
            }).forEach(function (item) {
                addOption(item[propertyName], selectElement);
            });
        };

        var isValueSelected = function (elementId) {
            return document.getElementById(elementId).selectedIndex !== 0;
        };

        var getSelectedValue = function (elementId) {
            var element = document.getElementById(elementId);
            return element.value;
        };

        var congressSelected = function () {
            displayDependentOptions("congress", "registrationType", "Congress", "Registration type");
        };

        var setAmountIfAllRegistrationInputSelected = function () {
            if (isValueSelected("congress") && isValueSelected("registrationType") && isValueSelected("participantType") && isValueSelected("location") && isValueSelected("currency")) {
                var congress = getSelectedValue("congress");
                var registrationType = getSelectedValue("registrationType");
                var participantType = getSelectedValue("participantType");
                var location = getSelectedValue("location");
                var registrationDetail = _.find(registrationDetails, function (item) {
                    return item["Congress"] === congress && item["Registration type"] === registrationType && item["Participant"] === participantType && item["Location"] === location;
                });

                var currency = getSelectedValue("currency");
                document.getElementById("amount").value = currency === 'INR' ? registrationDetail["Fees-Rs"] : registrationDetail["Fees-USD"];
            } else {
                document.getElementById("amount").value = '';
            }
        };

        var registrationTypeSelected = function () {
            setAmountIfAllRegistrationInputSelected();
        };

        var participantTypeSelected = function () {
            setAmountIfAllRegistrationInputSelected();
        };

        var locationTypeSelected = function () {
            setAmountIfAllRegistrationInputSelected();
        };

        var currencySelected = function () {
            setAmountIfAllRegistrationInputSelected();
        };

        window.onload = function () {
            setElementValue('tid', moment().format('YYMMDDhhmmss'));
            setElementValue("order_id", '00000000000000' + moment().format('YYYYMMDDhhmmssss'));
            setElementValueWithURL('redirect_url', 'ccavResponseHandler.php');
            setElementValueWithURL('cancel_url', 'ccavResponseHandler.php');

            displayFixedOptions("congress", "Congress");
            displayFixedOptions("participantType", "Participant");
            displayFixedOptions("location", "Location");
            var selectElement = document.getElementById("currency");
            addOption('Select', selectElement);
            addOption('INR', selectElement);
            addOption('USD', selectElement);
        };
    </script>
</head>
<body>
<form method="post" name="customerData" action="ccavRequestHandler.php">
    <table width="40%" height="100" border='1' align="center">
        <caption><font size="4" color="blue"><b>Integration Kit</b></font></caption>
    </table>
    <table width="40%" height="100" border='1' align="center">
        <tr>
            <td>Please choose Congress type</td>
            <td>
                <select id="congress" name="merchant_param1" onchange="congressSelected()"></select>
            </td>
        </tr>
        <tr>
            <td>Please choose Registration type</td>
            <td>
                <select id="registrationType" name="merchant_param2" onchange="registrationTypeSelected()"></select>
            </td>
        </tr>
        <tr>
            <td>Please choose your Participation type</td>
            <td>
                <select id="participantType" name="merchant_param3" onchange="participantTypeSelected()"></select>
            </td>
        </tr>
        <tr>
            <td>Please choose your location</td>
            <td>
                <select id="location" name="merchant_param4" onchange="locationTypeSelected()"></select>
            </td>
        </tr>
        <tr>
            <td>Currency :</td>
            <td>
                <select id="currency" name="merchant_param5" onchange="currencySelected()"></select>
            </td>
        </tr>
        <tr>
            <td>Amount :</td>
            <td><input type="text" name="amount" id="amount" readonly/></td>
        </tr>
        <tr>
            <td colspan="2">Billing information (all fields mandatory):</td>
        </tr>
        <tr>
            <td>Billing Name :</td>
            <td><input type="text" name="billing_name" value="Charlie"/></td>
        </tr>
        <tr>
            <td>Billing Address :</td>
            <td><input type="text" name="billing_address" value="Room no 1101, near Railway station Ambad"/></td>
        </tr>
        <tr>
            <td>Billing City :</td>
            <td><input type="text" name="billing_city" value="Ahmedabad"/></td>
        </tr>
        <tr>
            <td>Billing State :</td>
            <td><input type="text" name="billing_state" value="Gujarat"/></td>
        </tr>
        <tr>
            <td>Billing Zip :</td>
            <td><input type="text" name="billing_zip" value="382120"/></td>
        </tr>
        <tr>
            <td>Billing Country :</td>
            <td><input type="text" name="billing_country" value="India"/></td>
        </tr>
        <tr>
            <td>Billing Tel :</td>
            <td><input type="text" name="billing_tel" value="9999999999"/></td>
        </tr>
        <tr>
            <td>Billing Email :</td>
            <td><input type="text" name="billing_email" value="test@test.com"/></td>
        </tr>
        <!--<tr>-->
        <!--<td>Merchant Param1 :</td>-->
        <!--<td><input type="text" name="merchant_param1" value=""/></td>-->
        <!--</tr>-->
        <!--<tr>-->
        <!--<td>Merchant Param2 :</td>-->
        <!--<td><input type="text" name="merchant_param2" value=""/></td>-->
        <!--</tr>-->
        <!--<tr>-->
        <!--<td>Merchant Param3 :</td>-->
        <!--<td><input type="text" name="merchant_param3" value=""/></td>-->
        <!--</tr>-->
        <!--<tr>-->
        <!--<td>Merchant Param4 :</td>-->
        <!--<td><input type="text" name="merchant_param4" value=""/></td>-->
        <!--</tr>-->
        <!--<tr>-->
        <!--<td>Merchant Param5 :</td>-->
        <!--<td><input type="text" name="merchant_param5" value=""/></td>-->
        <!--</tr>-->
        <!--<tr>-->
        <!--<td>Promo Code :</td>-->
        <!--<td><input type="text" name="promo_code" value=""/></td>-->
        <!--</tr>-->
        <!--<tr>-->
        <!--<td>Vault Info. :</td>-->
        <!--<td><input type="text" name="customer_identifier" value=""/></td>-->
        <!--</tr>-->
        <tr>
            <td></td>
            <td><INPUT TYPE="submit" value="CheckOut"></td>
        </tr>
    </table>
    <input type="text" name="language" value="en" hidden/>
    <input type="text" name="integration_type" value="iframe_normal" hidden/>
    <input type="text" name="redirect_url" id="redirect_url" hidden/>
    <input type="text" name="cancel_url" id="cancel_url" hidden/>
    <input type="text" name="tid" id="tid" hidden/>
    <input type="text" name="merchant_id" value="146983" hidden/>
    <input type="text" name="order_id" id="order_id" hidden/>
</form>
</body>
</html>

